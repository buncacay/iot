@{
    ViewData["Title"] = "Điều khiển đèn LED";
    var username = ViewBag.User; 
}

<h2>Xin chào, @username!</h2>
<a href="/Account/Logout">Đăng xuất</a>

<div style="margin-top:20px;">
    <p id="statusText">Đang tải trạng thái...</p>
    <button id="btnToggle">Đang tải...</button>
</div>

<script>
    const btnToggle = document.getElementById("btnToggle");
    const statusText = document.getElementById("statusText");
    let debounceTimeout;

    async function fetchState() {
        try {
            const res = await fetch("/control");
            if (!res.ok) throw new Error("Không thể lấy trạng thái");
            const data = await res.json();
            updateUI(data.state);
        } catch (err) {
            console.error(err);
            statusText.innerText = "Lỗi kết nối server!";
        }
    }

    function updateUI(state) {
        statusText.innerText = `Trạng thái LED: ${state.toUpperCase()}`;
        btnToggle.innerText = state === "on" ? "Tắt đèn" : "Bật đèn";
        btnToggle.dataset.state = state;
    }

    btnToggle.addEventListener("click", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(async () => {
            const newState = btnToggle.dataset.state === "on" ? "off" : "on";
            try {
                const res = await fetch("/control", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ state: newState })
                });
                if (!res.ok) throw new Error("Không thể gửi lệnh");
                const data = await res.json();
                updateUI(data.state);
            } catch (err) {
                console.error(err);
                statusText.innerText = "Lỗi gửi lệnh!";
            }
        }, 300);
    });

    fetchState();
    setInterval(fetchState, 3000);
</script>
