@{
    ViewData["Title"] = "Điều khiển đèn";
}

<h2>Xin chào, @ViewBag.User!</h2>
<a href="/Home/Logout">Đăng xuất</a>

<p id="statusText">Đang tải trạng thái...</p>
<button id="btnToggle">Đang tải...</button>

<script>
    const btn = document.getElementById("btnToggle");
    const statusText = document.getElementById("statusText");

    // 🔹 Lấy trạng thái LED từ server
    async function loadState() {
        try {
            const res = await fetch(`/api/control/state`); // không cần /user nữa
            if (!res.ok) {
                statusText.innerText = "❌ Lỗi: " + res.status;
                return;
            }
            const data = await res.json();
            statusText.innerText = "Trạng thái: " + data.state;
            btn.innerText = data.state === "on" ? "Tắt đèn" : "Bật đèn";
        } catch (err) {
            statusText.innerText = "⚠️ Không thể kết nối server";
            console.error(err);
        }
    }

    // 🔹 Toggle LED
    async function toggleLed() {
        const newState = btn.innerText === "Bật đèn" ? "on" : "off";
        try {
            const res = await fetch("/api/control/set", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ state: newState }) // chỉ gửi state
            });

            if (!res.ok) {
                console.error("Lỗi POST:", res.status);
            }
            loadState(); // reload trạng thái mới
        } catch (err) {
            console.error(err);
        }
    }

    btn.addEventListener("click", toggleLed);
    loadState();
</script>
