@{
    ViewData["Title"] = "Điều khiển đèn";
}

<h2>Xin chào, @ViewBag.User!</h2>
<a href="/Home/Logout">Đăng xuất</a>

<p id="statusText">Đang tải trạng thái...</p>
<button id="btnToggle">Đang tải...</button>

<div class="sensor-section">
    <h3>Dữ liệu cảm biến môi trường</h3>
    <p>Nhiệt độ: <span id="temp">--</span> °C</p>
    <p>Độ ẩm: <span id="hum">--</span> %</p>
    <p>Ánh sáng: <span id="light">--</span></p>
</div>

<p id="ledMessage" style="color: green; font-weight: bold;"></p>

<script>
    const btn = document.getElementById("btnToggle");
    const statusText = document.getElementById("statusText");

    // --------- Cập nhật dữ liệu cảm biến ---------
    async function loadSensor() {
        try {
            const res = await fetch('/api/sensor/get');
            if (!res.ok) return;

            const result = await res.json();
            document.getElementById('temp').innerText = result.data.temperature.toFixed(1);
            document.getElementById('hum').innerText = result.data.humidity.toFixed(1);

            if (result.data.light !== undefined) {
                document.getElementById('light').innerText = result.data.light;
            } else {
                document.getElementById('light').innerText = "--";
            }
        } catch (err) {
            console.error(err);
        }
    }

    // Cập nhật mỗi 3 giây
    setInterval(loadSensor, 3000);
    loadSensor();

    // --------- Cập nhật trạng thái LED ---------
    async function loadState() {
        try {
            const res = await fetch('/api/control/state');
            if (!res.ok) {
                statusText.innerText = "Lỗi tải trạng thái (" + res.status + ")";
                return;
            }

            const data = await res.json();
            statusText.innerText = "Trạng thái: " + data.state;
            btn.innerText = data.state === "on" ? "Tắt đèn" : "Bật đèn";
            btn.style.background = data.state === "on" ? "#ff6666" : "#4CAF50";
            btn.style.color = "white";
            btn.style.padding = "8px 16px";
            btn.style.border = "none";
            btn.style.borderRadius = "6px";
            btn.style.cursor = "pointer";

        } catch (err) {
            statusText.innerText = "Không thể kết nối server";
            console.error(err);
        }
    }

    // --------- Nút bật/tắt LED ---------
    async function toggleLed() {
        const newState = btn.innerText === "Bật đèn" ? "on" : "off";
        try {
            const res = await fetch("/api/control/set", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ state: newState })
            });

            if (!res.ok) {
                console.error("Lỗi POST:", res.status);
                return;
            }

            const data = await res.json();
            console.log("Đã cập nhật:", data);

            // Reload trạng thái LED
            await loadState();

            // Lấy dữ liệu cảm biến để hiển thị ánh sáng
            const sensorRes = await fetch('/api/sensor/get');
            const sensorData = sensorRes.ok ? await sensorRes.json() : null;

            let message = `Đã ${newState === "on" ? "bật" : "tắt"} đèn thành công.`;
            if (sensorData && sensorData.data.light !== undefined) {
                message += ` Ánh sáng hiện tại: ${sensorData.data.light}`;
            }

            document.getElementById('ledMessage').innerText = message;

        } catch (err) {
            console.error(err);
        }
    }

    // --------- Thêm sự kiện nút ---------
    btn.addEventListener("click", toggleLed);

    // Load trạng thái LED ban đầu
    loadState();
</script>
