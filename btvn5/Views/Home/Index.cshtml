@{
    ViewData["Title"] = "Điều khiển đèn";
}

<h2>Xin chào, @ViewBag.User!</h2>
<a href="/Home/Logout">Đăng xuất</a>

<p id="statusText">Đang tải trạng thái...</p>
<button id="btnToggle">Đang tải...</button>

<div class="sensor-section">
    <h3>Dữ liệu cảm biến môi trường</h3>
    <p>Nhiệt độ: <span id="temp">--</span> °C</p>
    <p>Độ ẩm: <span id="hum">--</span> %</p>
</div>

<p id="ledMessage" style="color: green; font-weight: bold;"></p>

<script>
    const btn = document.getElementById("btnToggle");
    const statusText = document.getElementById("statusText");
    const ledMessage = document.getElementById("ledMessage");

    let lastLedState = null;

    // ✅ Load cảm biến (mỗi 3s)
    async function loadSensor() {
        try {
            const res = await fetch('/api/sensor/get');
            if (!res.ok) return;
            const result = await res.json();
            document.getElementById('temp').innerText = result.data.temperature.toFixed(1);
            document.getElementById('hum').innerText = result.data.humidity.toFixed(1);
        } catch (err) {
            console.error(err);
        }
    }

    // ✅ Load trạng thái đèn (chỉ update UI)
    async function loadState() {
        try {
            const res = await fetch('/api/control/state');
            if (!res.ok) {
                statusText.innerText = "Lỗi tải trạng thái (" + res.status + ")";
                return;
            }
            const data = await res.json();

            statusText.innerText = "Trạng thái: " + data.state + " | Ánh sáng: " + data.light;
            btn.innerText = data.state === "on" ? "Tắt đèn" : "Bật đèn";
            btn.style.background = data.state === "on" ? "#ff6666" : "#4CAF50";
            btn.style.color = "white";
            btn.style.padding = "8px 16px";
            btn.style.border = "none";
            btn.style.borderRadius = "6px";
            btn.style.cursor = "pointer";

            lastLedState = data.state;

        } catch (err) {
            statusText.innerText = "Không thể kết nối server";
            console.error(err);
        }
    }

    // ✅ Bật/tắt đèn (hiển thị message từ server)
    async function toggleLed() {
        const newState = btn.innerText === "Bật đèn" ? "on" : "off";
        try {
            const res = await fetch("/api/control/set", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ state: newState })
            });

            if (!res.ok) {
                ledMessage.innerText = "❌ Lỗi khi gửi lệnh tới server.";
                ledMessage.style.color = "red";
                return;
            }

            const data = await res.json();

            // ✅ Cập nhật giao diện
            statusText.innerText = "Trạng thái: " + data.state;
            btn.innerText = data.state === "on" ? "Tắt đèn" : "Bật đèn";
            btn.style.background = data.state === "on" ? "#ff6666" : "#4CAF50";

            // ✅ Hiển thị message từ server
            ledMessage.innerText = data.message;
            ledMessage.style.color = data.message.includes("thành công") ? "green" : "orange";

            lastLedState = data.state;

        } catch (err) {
            console.error(err);
            ledMessage.innerText = "⚠️ Lỗi kết nối server!";
            ledMessage.style.color = "red";
        }
    }

    // ✅ Gán event click và tự động refresh
    btn.addEventListener("click", toggleLed);
    loadState();
    loadSensor();
    setInterval(loadState, 3000);
    setInterval(loadSensor, 3000);
</script>
