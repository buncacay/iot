@{
    ViewData["Title"] = "Điều khiển đèn";
}

<h2>Xin chào, @ViewBag.User!</h2>
<a href="/Home/Logout">Đăng xuất</a>

<p id="statusText">Đang tải trạng thái...</p>
<button id="btnToggle">Đang tải...</button>

<script>
    const btn = document.getElementById("btnToggle");
    const statusText = document.getElementById("statusText");

    async function loadState() {
        try {
            const res = await fetch(`/api/control/state`);
            if (!res.ok) {
                statusText.innerText = "Lỗi tải trạng thái (" + res.status + ")";
                return;
            }

            const data = await res.json();
            statusText.innerText = "Trạng thái: " + data.state;
            btn.innerText = data.state === "on" ? "Tắt đèn" : "Bật đèn";
            btn.style.background = data.state === "on" ? "#ff6666" : "#4CAF50";
            btn.style.color = "white";
            btn.style.padding = "8px 16px";
            btn.style.border = "none";
            btn.style.borderRadius = "6px";
            btn.style.cursor = "pointer";

        } catch (err) {
            statusText.innerText = " Không thể kết nối server";
            console.error(err);
        }
    }

    async function toggleLed() {
        const newState = btn.innerText === "Bật đèn" ? "on" : "off";
        try {
            const res = await fetch("/api/control/set", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ state: newState })
            });

            if (!res.ok) {
                console.error(" Lỗi POST:", res.status);
                return;
            }

            const data = await res.json();
            console.log("Đã cập nhật:", data);
            loadState(); // reload lại trạng thái sau khi thay đổi

        } catch (err) {
            console.error(err);
        }
    }

    btn.addEventListener("click", toggleLed);
    loadState();
</script>
