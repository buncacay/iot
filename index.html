<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ESP Control Panel (Firebase)</title>

<!-- Firebase v8 compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body { font-family: Arial; padding: 20px; background: #f9f9f9; }
#alertBox { padding: 12px; border:1px solid #aaa; border-radius:8px; margin-bottom:20px; background:#fff3cd; max-height:140px; overflow-y:auto; }
.grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:15px; }
.card { background:#fff; border-radius:12px; padding:15px; box-shadow:0 4px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; align-items:center; }
.btn { width:100%; padding:12px; margin-bottom:10px; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; }
.btn:disabled { background:#ddd; cursor:not-allowed; }
label{display:inline-block; width:70px;}
small { color:#666; }
</style>
</head>
<body>

<div id="alertBox"><ul id="alertList"></ul></div>

<div class="grid">
  <div class="card">
    <button id="btnAuto" class="btn">Chế độ: ---</button>
    <small>* Auto tắt/bật đèn theo lịch</small>
  </div>

  <div class="card">
    <div>Mực nước: <b><span id="waterValue">---</span> mm</b></div>
    <div>Nhiệt độ: <b><span id="tempValue">---</span> °C</b></div>
  </div>

  <div class="card">
    <button id="btnLight" class="btn">Đèn: ---</button>
    <p>Số lần bật: <span id="lightCount">0</span></p>
    <div>
      <label>Bật từ</label><input id="lightStart" type="time"><br><br>
      <label>Đến</label><input id="lightEnd" type="time"><br><br>
      <button id="saveLightSchedule" class="btn">Lưu lịch</button>
    </div>
  </div>

  <div class="card">
    <button id="btnPump" class="btn">Bơm: ---</button>
    <p>Số lần bật: <span id="pumpCount">0</span></p>
    <div>
      <label>Ngưỡng</label><input id="threshold" type="number" min="0"><br><br>
      <button id="saveThreshold" class="btn">Lưu ngưỡng</button>
    </div>
  </div>
</div>

<script>
/* Firebase config */
var firebaseConfig = {
  apiKey: "AIzaSyDxAPWDdTzTHbK9Bggzet9l9G0U0r2fMDI",
  authDomain: "pump-88184.firebaseapp.com",
  databaseURL: "https://pump-88184-default-rtdb.firebaseio.com",
  projectId: "pump-88184"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();
var auth = firebase.auth();

/* LOGIN */
var USER_EMAIL = "a@gmail.com";
var USER_PASS  = "1234567";
auth.signInWithEmailAndPassword(USER_EMAIL, USER_PASS)
.then(()=> console.log("Web logged in"))
.catch(e => { alert("Login failed: "+e.message); console.error(e); });

/* UI elements */
const btnAuto = document.getElementById("btnAuto");
const btnPump = document.getElementById("btnPump");
const btnLight = document.getElementById("btnLight");
const waterVal = document.getElementById("waterValue");
const tempVal  = document.getElementById("tempValue");
const pumpCountElem = document.getElementById("pumpCount");
const lightCountElem = document.getElementById("lightCount");
const lightStart = document.getElementById("lightStart");
const lightEnd = document.getElementById("lightEnd");
const saveLightSchedule = document.getElementById("saveLightSchedule");
const thresholdInput = document.getElementById("threshold");
const saveThreshold = document.getElementById("saveThreshold");

let alertQueue = [];
function addAlert(msg, color="orange"){
  if(alertQueue.length >= 3) alertQueue.pop();
  alertQueue.unshift({msg,color});
  renderAlerts();
}
function renderAlerts(){
  const list = document.getElementById("alertList");
  list.innerHTML = "";
  alertQueue.forEach(a=>{
    const li = document.createElement("li");
    li.style.color = a.color;
    li.style.fontWeight = "bold";
    li.innerText = a.msg;
    list.appendChild(li);
  });
}

/* Listen status (/fish/status) từ ESP hoặc Firebase */
db.ref("/fish/status").on("value", snap=>{
  if(!snap.exists()) return;
  const s = snap.val();

  waterVal.innerText = s.distance_mm !== undefined ? s.distance_mm : "---";
  tempVal.innerText = s.temperature !== undefined ? s.temperature : "---";
  pumpCountElem.innerText = s.pumpCount !== undefined ? s.pumpCount : 0;
  lightCountElem.innerText = s.lightCount !== undefined ? s.lightCount : 0;

  // alerts từ ESP
  if (s.fastDropAlert) addAlert("⚠ Nước giảm nhanh!", "red");
  if (s.distance_mm !== undefined && s.distance_mm < (s.thresholdMM || 50)) addAlert("⚠ Mực nước dưới ngưỡng!", "orange");
});

/* Listen config (/fish/config) */
db.ref("/fish/config").on("value", snap=>{
  if(!snap.exists()) return;
  const c = snap.val();

  if (c.thresholdMM !== undefined) thresholdInput.value = c.thresholdMM;
  if (c.lightSchedule && c.lightSchedule.start) lightStart.value = c.lightSchedule.start;
  if (c.lightSchedule && c.lightSchedule.end)   lightEnd.value   = c.lightSchedule.end;
});

/* Listen control node (/fish) */
db.ref("/fish").on("value", snap=>{
  if(!snap.exists()) return;
  const d = snap.val();

  btnAuto.innerText = "Chế độ: " + (d.auto ? "AUTO" : "MANUAL");
  btnPump.innerText = "Bơm: " + (d.pump ? "ON" : "OFF");
  btnLight.innerText = "Đèn: " + (d.light ? "ON" : "OFF");

  btnPump.disabled = d.auto;
  btnLight.disabled = d.auto;
});

/* UI actions -> write Firebase */
btnAuto.onclick = ()=> {
  db.ref("/fish/auto").once("value").then(snap => {
    db.ref("/fish/auto").set(!snap.val());
  });
};

btnPump.onclick = ()=> {
  db.ref("/fish/pump").once("value").then(snap => {
    db.ref("/fish/pump").set(!snap.val());
  });
};

btnLight.onclick = ()=> {
  db.ref("/fish/light").once("value").then(snap => {
    db.ref("/fish/light").set(!snap.val());
  });
};

saveThreshold.onclick = ()=>{
  const v = Number(thresholdInput.value || 0);
  db.ref("/fish/config/thresholdMM").set(v);
  addAlert("Đã lưu ngưỡng: " + v + " mm", "green");
};

saveLightSchedule.onclick = ()=>{
  const s = lightStart.value;
  const e = lightEnd.value;
  if (!s || !e) return alert("Chọn giờ hợp lệ");
  db.ref("/fish/config/lightSchedule/start").set(s);
  db.ref("/fish/config/lightSchedule/end").set(e);
  addAlert("Đã lưu lịch đèn: " + s + " → " + e, "green");
};
</script>
</body>
</html>
